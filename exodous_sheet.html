<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLACKLOG.NET // PERSONNEL RECORD</title>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            /* Political High Tech Theme Palette */
            --bg-dark: #0f172a;
            --bg-panel: #1e293b;
            --bg-input: #020617;

            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #475569;

            --accent-primary: #38bdf8;
            /* Cyan/Blue */
            --accent-glow: rgba(56, 189, 248, 0.3);
            --accent-danger: #ef4444;
            --accent-success: #22c55e;
            --accent-warning: #eab308;

            --border-color: #334155;

            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-mono: 'Consolas', 'Monaco', 'Courier New', monospace;

            --grid-spacing: 1rem;
            --radius-sm: 4px;
            --radius-md: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-primary);
            font-family: var(--font-main);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.5;
        }

        /* Utility Classes for Theme */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .tech-border {
            border: 1px solid var(--border-color);
            position: relative;
        }

        .tech-border::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent-primary), transparent);
            opacity: 0.5;
        }

        .mono-text {
            font-family: var(--font-mono);
            letter-spacing: 0.05em;
        }

        .text-accent {
            color: var(--accent-primary);
        }

        .text-danger {
            color: var(--accent-danger);
        }

        .text-muted {
            color: var(--text-muted);
        }

        /* Scroller */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        #root {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Loading State & Boot Sequence */
        .loading-screen {
            display: flex;
            height: 100vh;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: var(--accent-primary);
            background: #000;
            z-index: 9999;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
        }

        .boot-text {
            font-family: var(--font-mono);
            color: var(--accent-primary);
            font-size: 14px;
            white-space: pre;
            line-height: 1.2;
        }

        /* Redaction Effect */
        .classified {
            background: var(--text-primary);
            color: var(--text-primary);
            cursor: help;
            transition: all 0.3s ease;
            padding: 0 4px;
            border-radius: 2px;
            user-select: none;
        }

        .classified:hover {
            background: transparent;
            color: var(--accent-danger);
            text-shadow: 0 0 5px var(--accent-danger);
        }

        @keyframes glitch {
            0% {
                transform: translate(0)
            }

            20% {
                transform: translate(-2px, 2px)
            }

            40% {
                transform: translate(-2px, -2px)
            }

            60% {
                transform: translate(2px, 2px)
            }

            80% {
                transform: translate(2px, -2px)
            }

            100% {
                transform: translate(0)
            }
        }

        .glitch-hover:hover {
            animation: glitch 0.2s cubic-bezier(.25, .46, .45, .94) both infinite;
            color: var(--accent-danger);
        }
    </style>
</head>

<body>
    <div id="root">
        <div class="loading-screen">
            <h1 class="mono-text">INITIALIZING BLACKLOG.NET PROTOCOLS...</h1>
        </div>
    </div>

    <script type="text/babel">
        // Debug Error Handler
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            alert('Error: ' + msg + '\nLine: ' + lineNo);
            return false;
        };

        const { useState, useEffect, useMemo } = React;

        // --- DATA STRUCTURES ---
        const DEFAULT_CHARACTER = {
            id: null,
            name: "UNKNOWN AGENT",
            concept: "",
            chronicle: "",
            virtue: "",
            vice: "",
            attributes: {
                power: { mental: 1, physical: 1, social: 1 },
                finesse: { mental: 1, physical: 1, social: 1 },
                resistance: { mental: 1, physical: 1, social: 1 }
            },
            skills: {
                mental: {
                    Academics: 0, Computer: 0, Crafts: 0, Investigation: 0,
                    Medicine: 0, Occult: 0, Politics: 0, Science: 0
                },
                physical: {
                    Athletics: 0, Brawl: 0, Drive: 0, Firearms: 0,
                    Larceny: 0, Stealth: 0, Survival: 0, Weaponry: 0
                },
                social: {
                    AnimalKen: 0, Empathy: 0, Expression: 0, Intimidation: 0,
                    Persuasion: 0, Socialize: 0, Streetwise: 0, Subterfuge: 0
                }
            },
            merits: [],
            flaws: [],
            pullingStrings: [],
            inventory: [],
            health: { damage: 0, max_mod: 0 },
            willpower: { current: 0, max_mod: 0 },
            experience: 0
        };

        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);

        // --- COMPONENTS ---

        // Simple Icon Component
        const Icon = ({ name, size = 16, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // Redacted Text Component
        const Redacted = ({ children }) => (
            <span className="classified" title="CLASSIFIED // CLEARANCE REQUIRED">{children}</span>
        );

        const Dashboard = ({ characters, onCreate, onSelect, onDelete }) => {
            const [newName, setNewName] = useState("");

            return (
                <div className="glass-panel" style={{ padding: '2rem', maxWidth: '800px', margin: '2rem auto' }}>
                    <h2 className="text-primary mono-text" style={{ marginBottom: '1.5rem', borderBottom: '1px solid var(--border-color)', paddingBottom: '0.5rem' }}>
                        <Icon name="users" /> OPERATIVE DATABASE
                    </h2>

                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: '1rem', marginBottom: '2rem' }}>
                        {characters.map(char => (
                            <div key={char.id} className="tech-border glitch-hover" style={{ padding: '1rem', background: 'var(--bg-panel)', cursor: 'pointer', transition: 'all 0.2s' }}
                                onClick={() => onSelect(char.id)}>
                                <h3 className="text-accent mono-text" style={{ fontSize: '1.1rem' }}>{char.name}</h3>
                                <p className="text-secondary" style={{ fontSize: '0.9rem' }}>{char.concept || <Redacted>UNKNOWN</Redacted>}</p>
                                <div style={{ marginTop: '1rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <span className="text-muted" style={{ fontSize: '0.8rem' }}>ID: {char.id.substr(0, 4)}</span>
                                    <button className="text-danger" style={{ background: 'none', border: 'none', cursor: 'pointer' }}
                                        onClick={(e) => { e.stopPropagation(); onDelete(char.id); }}>
                                        <Icon name="trash-2" size={14} />
                                    </button>
                                </div>
                            </div>
                        ))}

                        <div className="tech-border" style={{ padding: '1rem', display: 'flex', flexDirection: 'column', justifyContent: 'center', alignItems: 'center', borderStyle: 'dashed', opacity: 0.7 }}>
                            <input
                                type="text"
                                placeholder="CODENAME"
                                value={newName}
                                onChange={(e) => setNewName(e.target.value)}
                                style={{ background: 'var(--bg-input)', border: '1px solid var(--border-color)', color: 'white', padding: '0.5rem', marginBottom: '0.5rem', width: '100%' }}
                            />
                            <button
                                onClick={() => { if (newName) { onCreate(newName); setNewName(""); } }}
                                style={{ background: 'var(--accent-primary)', border: 'none', color: 'var(--bg-dark)', padding: '0.5rem 1rem', cursor: 'pointer', fontWeight: 'bold' }}>
                                <Icon name="plus" size={14} /> INITIALIZE NEW
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [characters, setCharacters] = useState([]);
            const [activeCharId, setActiveCharId] = useState(null);
            const [booting, setBooting] = useState(false); // DEBUG: Skip boot
            const [bootLog, setBootLog] = useState([]);

            const activeChar = useMemo(() => {
                return characters.find(c => c.id === activeCharId) || null;
            }, [characters, activeCharId]);

            // Boot Sequence Effect
            useEffect(() => {
                if (booting) { // Only run if booting is true
                    const logs = [
                        "INITIALIZING BLACKLOG.NET KERNEL...",
                        "LOADING ENCRYPTED MODULES...",
                        "ESTABLISHING SECURE CONNECTION...",
                        "AUTHENTICATING BIOMETRICS...",
                        "ACCESS GRANTED."
                    ];

                    let delay = 0;
                    logs.forEach((log, index) => {
                        delay += Math.random() * 500 + 300;
                        setTimeout(() => {
                            setBootLog(prev => [...prev, log]);
                        }, delay);
                    });

                    setTimeout(() => setBooting(false), delay + 800);
                }
            }, [booting]);

            // Load from LocalStorage on mount
            useEffect(() => {
                const saved = localStorage.getItem('foundation_chars');
                if (saved) {
                    try {
                        setCharacters(JSON.parse(saved));
                    } catch (e) {
                        console.error("Corruption in data stream", e);
                    }
                }
            }, []);

            // Save to LocalStorage on change
            useEffect(() => {
                if (characters.length > 0) {
                    localStorage.setItem('foundation_chars', JSON.stringify(characters));
                }
            }, [characters]);

            const createCharacter = (name) => {
                const newChar = { ...DEFAULT_CHARACTER, id: generateId(), name };
                setCharacters([...characters, newChar]);
            };

            const deleteCharacter = (id) => {
                if (confirm("WARNING: TERMINATING OPERATIVE RECORD. CONFIRM?")) {
                    setCharacters(characters.filter(c => c.id !== id));
                    if (activeCharId === id) setActiveCharId(null);
                }
            };

            const updateActiveCharacter = (updates) => {
                setCharacters(characters.map(c => c.id === activeCharId ? { ...c, ...updates } : c));
            };

            // --- MODULES ---

            const StatDots = ({ value, max = 5, onChange, editable }) => {
                return (
                    <div style={{ display: 'flex', gap: '4px' }}>
                        {[...Array(max)].map((_, i) => (
                            <div
                                key={i}
                                onClick={() => editable && onChange(i + 1 === value && value === 1 ? 0 : i + 1)}
                                style={{
                                    width: '12px', height: '12px', borderRadius: '50%',
                                    border: '1px solid var(--text-muted)',
                                    background: i < value ? 'var(--accent-primary)' : 'transparent',
                                    cursor: editable ? 'pointer' : 'default',
                                    boxShadow: i < value ? '0 0 5px var(--accent-glow)' : 'none'
                                }}
                            />
                        ))}
                    </div>
                );
            };

            const HeaderModule = ({ char, update }) => (
                <div className="glass-panel" style={{ padding: '1.5rem', marginBottom: '1rem', display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem' }}>
                    <div>
                        <label className="text-secondary mono-text" style={{ fontSize: '0.8rem' }}>CODENAME</label>
                        <input type="text" value={char.name} onChange={e => update({ name: e.target.value })}
                            style={{ background: 'transparent', border: 'none', borderBottom: '1px solid var(--accent-primary)', color: 'var(--text-primary)', width: '100%', fontSize: '1.2rem', fontFamily: 'var(--font-mono)' }} />
                    </div>
                    <div>
                        <label className="text-secondary mono-text" style={{ fontSize: '0.8rem' }}>CONCEPT</label>
                        <input type="text" value={char.concept} onChange={e => update({ concept: e.target.value })}
                            style={{ background: 'transparent', border: 'none', borderBottom: '1px solid var(--border-color)', color: 'var(--text-primary)', width: '100%' }} />
                    </div>
                    <div>
                        <label className="text-secondary mono-text" style={{ fontSize: '0.8rem' }}>CHRONICLE</label>
                        <input type="text" value={char.chronicle} onChange={e => update({ chronicle: e.target.value })}
                            style={{ background: 'transparent', border: 'none', borderBottom: '1px solid var(--border-color)', color: 'var(--text-primary)', width: '100%' }} />
                    </div>
                    <div>
                        <label className="text-secondary mono-text" style={{ fontSize: '0.8rem' }}>VIRTUE / VICE</label>
                        <div style={{ display: 'flex', gap: '0.5rem' }}>
                            <input type="text" placeholder="Virtue" value={char.virtue} onChange={e => update({ virtue: e.target.value })}
                                style={{ background: 'transparent', border: 'none', borderBottom: '1px solid var(--border-color)', color: 'var(--text-primary)', width: '50%' }} />
                            <span className="text-muted">/</span>
                            <input type="text" placeholder="Vice" value={char.vice} onChange={e => update({ vice: e.target.value })}
                                style={{ background: 'transparent', border: 'none', borderBottom: '1px solid var(--border-color)', color: 'var(--text-primary)', width: '50%' }} />
                        </div>
                    </div>
                </div>
            );

            const AttributesModule = ({ attributes, update }) => {
                const updateAttr = (cat, type, val) => update({ ...attributes, [cat]: { ...attributes[cat], [type]: val } });

                return (
                    <div className="glass-panel" style={{ padding: '1.5rem', marginBottom: '1rem' }}>
                        <h3 className="mono-text text-accent" style={{ borderBottom: '1px solid var(--border-color)', paddingBottom: '0.5rem', marginBottom: '1rem' }}>ATTRIBUTES</h3>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '2rem' }}>
                            {/* Headers */}
                            <div className="text-center text-muted mono-text">MENTAL</div>
                            <div className="text-center text-muted mono-text">PHYSICAL</div>
                            <div className="text-center text-muted mono-text">SOCIAL</div>

                            {/* Power */}
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <span>Intelligence</span>
                                <StatDots value={attributes.power.mental} onChange={v => updateAttr('power', 'mental', v)} editable />
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <span>Strength</span>
                                <StatDots value={attributes.power.physical} onChange={v => updateAttr('power', 'physical', v)} editable />
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <span>Presence</span>
                                <StatDots value={attributes.power.social} onChange={v => updateAttr('power', 'social', v)} editable />
                            </div>

                            {/* Finesse */}
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <span>Wits</span>
                                <StatDots value={attributes.finesse.mental} onChange={v => updateAttr('finesse', 'mental', v)} editable />
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <span>Dexterity</span>
                                <StatDots value={attributes.finesse.physical} onChange={v => updateAttr('finesse', 'physical', v)} editable />
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <span>Manipulation</span>
                                <StatDots value={attributes.finesse.social} onChange={v => updateAttr('finesse', 'social', v)} editable />
                            </div>

                            {/* Resistance */}
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <span>Resolve</span>
                                <StatDots value={attributes.resistance.mental} onChange={v => updateAttr('resistance', 'mental', v)} editable />
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <span>Stamina</span>
                                <StatDots value={attributes.resistance.physical} onChange={v => updateAttr('resistance', 'physical', v)} editable />
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <span>Composure</span>
                                <StatDots value={attributes.resistance.social} onChange={v => updateAttr('resistance', 'social', v)} editable />
                            </div>
                        </div>
                    </div>
                );
            };

            const SkillsModule = ({ skills, update }) => {
                const updateSkill = (cat, name, val) => update({ ...skills, [cat]: { ...skills[cat], [name]: val } });

                const SkillCol = ({ category, title }) => (
                    <div>
                        <h4 className="text-center text-muted mono-text" style={{ marginBottom: '1rem', textTransform: 'uppercase' }}>{title}</h4>
                        {Object.entries(skills[category]).map(([name, val]) => (
                            <div key={name} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>
                                <span style={{ fontSize: '0.9rem', color: val === 0 ? 'var(--text-muted)' : 'var(--text-primary)' }}>
                                    {name.replace(/([A-Z])/g, ' $1').trim()}
                                    {val === 0 && <span style={{ fontSize: '0.7em', marginLeft: '4px', opacity: 0.5 }}>(-{category === 'mental' ? 3 : 1})</span>}
                                </span>
                                <StatDots value={val} onChange={v => updateSkill(category, name, v)} editable />
                            </div>
                        ))}
                    </div>
                );

                return (
                    <div className="glass-panel" style={{ padding: '1.5rem', marginBottom: '1rem' }}>
                        <h3 className="mono-text text-accent" style={{ borderBottom: '1px solid var(--border-color)', paddingBottom: '0.5rem', marginBottom: '1rem' }}>SKILLS</h3>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '2rem' }}>
                            <SkillCol category="mental" title="Mental (-3 Unskilled)" />
                            <SkillCol category="physical" title="Physical (-1 Unskilled)" />
                            <SkillCol category="social" title="Social (-1 Unskilled)" />
                        </div>
                    </div>
                );
            };

            // --- MAIN APP CONNECTOR ---
            const ExpandableListModule = ({ title, items, onAdd, onRemove, onUpdate, itemLabel = "Item" }) => (
                <div className="glass-panel" style={{ padding: '1.5rem', marginBottom: '1rem' }}>
                    <h3 className="mono-text text-accent" style={{ borderBottom: '1px solid var(--border-color)', paddingBottom: '0.5rem', marginBottom: '1rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        {title}
                        <button onClick={onAdd} title="Add New" style={{ background: 'transparent', border: '1px solid var(--accent-primary)', color: 'var(--accent-primary)', width: '24px', height: '24px', borderRadius: '4px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <Icon name="plus" size={14} />
                        </button>
                    </h3>
                    {items.map((item, idx) => (
                        <div key={idx} className="tech-border" style={{ padding: '0.5rem', marginBottom: '0.5rem', background: 'rgba(0,0,0,0.2)' }}>
                            <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                                <input
                                    type="text"
                                    placeholder={`${itemLabel} Name`}
                                    value={item.name}
                                    onChange={(e) => onUpdate(idx, { ...item, name: e.target.value })}
                                    style={{ background: 'transparent', border: 'none', borderBottom: '1px solid var(--text-muted)', color: 'var(--text-primary)', flex: 1, fontFamily: 'var(--font-mono)' }}
                                />
                                <StatDots value={item.rating} max={5} onChange={(v) => onUpdate(idx, { ...item, rating: v })} editable />
                                <button onClick={() => onRemove(idx)} style={{ background: 'transparent', border: 'none', color: 'var(--accent-danger)', cursor: 'pointer' }}>
                                    <Icon name="x" size={14} />
                                </button>
                            </div>
                            <textarea
                                placeholder="Description / Effects..."
                                value={item.description || ""}
                                onChange={(e) => onUpdate(idx, { ...item, description: e.target.value })}
                                style={{ width: '100%', background: 'transparent', border: 'none', color: 'var(--text-secondary)', fontSize: '0.8rem', marginTop: '0.5rem', minHeight: '40px', fontFamily: 'inherit', resize: 'vertical' }}
                            />
                        </div>
                    ))}
                    {items.length === 0 && <p className="text-muted text-center" style={{ fontSize: '0.8rem', fontStyle: 'italic' }}>No data recorded.</p>}
                </div>
            );

            const HealthModule = ({ health, max, update }) => {
                // Visualize damage boxes (nWoD style: [ / ] [ X ] [ * ])
                // For this app, we'll simplify to a numeric counter + EKG visual
                // But let's add the checkboxes too for purists

                const damageType = (index) => {
                    if (index < health.aggravated) return "aggravated";
                    if (index < health.aggravated + health.lethal) return "lethal";
                    if (index < health.aggravated + health.lethal + health.bashing) return "bashing";
                    return "none";
                }

                return (
                    <div className="glass-panel" style={{ padding: '1.5rem', marginBottom: '1rem', border: '1px solid var(--accent-danger)' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                            <h3 className="mono-text text-danger">BIOSIGN MONITOR</h3>
                            <div className="text-danger mono-text" style={{ animation: 'pulse 2s infinite' }}>Tracking vital signs...</div>
                        </div>

                        {/* EKG Visual Placeholder - CSS Animation would go here */}
                        <div style={{ height: '60px', background: 'rgba(0,0,0,0.3)', marginBottom: '1rem', position: 'relative', overflow: 'hidden', borderLeft: '2px solid var(--accent-danger)' }}>
                            <svg width="100%" height="100%" viewBox="0 0 300 60" preserveAspectRatio="none">
                                <path d="M0,30 L20,30 L25,10 L35,50 L40,30 L300,30"
                                    fill="none" stroke="var(--accent-danger)" strokeWidth="2"
                                    vectorEffect="non-scaling-stroke"
                                    className="ekg-line"
                                    style={{ animation: 'dash 2s linear infinite' }}
                                />
                            </svg>
                        </div>
                        <style>{`
                        @keyframes dash {
                            0% { stroke-dasharray: 0, 1000; stroke-dashoffset: 0; }
                            100% { stroke-dasharray: 1000, 0; stroke-dashoffset: -1000; }
                        }
                    `}</style>

                        <div style={{ display: 'flex', justifyContent: 'center', gap: '0.5rem', flexWrap: 'wrap' }}>
                            {[...Array(max)].map((_, i) => (
                                <div key={i}
                                    onClick={() => {
                                        // Simple cycle: None -> Bashing (/) -> Lethal (X) -> Aggravated (*) -> None
                                        // This logic is simplified; a real app needs properly ordered damage filling.
                                        // For now, let's just use a simplified damage counter system instead of complex box logic for this MVP step.
                                    }}
                                    style={{
                                        width: '24px', height: '24px', border: '1px solid var(--accent-danger)',
                                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                                        color: 'var(--accent-danger)', fontWeight: 'bold'
                                    }}>
                                    {/* Visual representation of boxes would go here based on state */}
                                </div>
                            ))}
                        </div>

                        <div style={{ display: 'flex', gap: '2rem', justifyContent: 'center', marginTop: '1rem' }}>
                            <div className="text-center">
                                <label className="text-muted mono-text" style={{ fontSize: '0.8rem' }}>BASHING</label>
                                <input type="number" value={health.bashing || 0} onChange={(e) => update({ ...health, bashing: parseInt(e.target.value) || 0 })}
                                    style={{ display: 'block', background: 'transparent', border: '1px solid var(--accent-danger)', color: 'var(--accent-danger)', width: '60px', textAlign: 'center', fontSize: '1.2rem' }} />
                            </div>
                            <div className="text-center">
                                <label className="text-muted mono-text" style={{ fontSize: '0.8rem' }}>LETHAL</label>
                                <input type="number" value={health.lethal || 0} onChange={(e) => update({ ...health, lethal: parseInt(e.target.value) || 0 })}
                                    style={{ display: 'block', background: 'transparent', border: '1px solid var(--accent-danger)', color: 'var(--accent-danger)', width: '60px', textAlign: 'center', fontSize: '1.2rem' }} />
                            </div>
                            <div className="text-center">
                                <label className="text-muted mono-text" style={{ fontSize: '0.8rem' }}>AGGRAVATED</label>
                                <input type="number" value={health.aggravated || 0} onChange={(e) => update({ ...health, aggravated: parseInt(e.target.value) || 0 })}
                                    style={{ display: 'block', background: 'transparent', border: '1px solid var(--accent-danger)', color: 'var(--accent-danger)', width: '60px', textAlign: 'center', fontSize: '1.2rem' }} />
                            </div>
                        </div>
                    </div>
                );
            };

            const DiceRoller = ({ char }) => {
                const [pool, setPool] = useState(1);
                const [again, setAgain] = useState(10);
                const [results, setResults] = useState(null);

                const roll = () => {
                    const newResults = [];
                    let successes = 0;
                    let diceToRoll = pool;

                    // Safety cap
                    if (diceToRoll > 50) diceToRoll = 50;
                    if (diceToRoll < 1) {
                        // Chance die logic could go here
                    }

                    while (diceToRoll > 0) {
                        const die = Math.floor(Math.random() * 10) + 1;
                        let isSuccess = die >= 8;
                        let explode = die >= again;

                        newResults.push({ value: die, success: isSuccess, exploded: explode });
                        if (isSuccess) successes++;

                        if (explode) {
                            // Reroll logic handled by just looping? 
                            // No, "10-again" means ADD a die.
                            diceToRoll++;
                            // But we need to be careful of infinite loops with lower again-ratings (like 8-again).
                            // Let's limit explosions to avoid crashes in this simple implementation.
                            if (newResults.length > 100) break;
                        }
                        diceToRoll--;
                    }
                    setResults({ rolls: newResults, totalSuccesses: successes });
                };

                return (
                    <div className="glass-panel" style={{ padding: '1.5rem', marginBottom: '1rem', borderTop: '2px solid var(--accent-primary)' }}>
                        <h3 className="mono-text text-accent" style={{ marginBottom: '1rem' }}>TACTICAL DICE ROLLER</h3>

                        <div style={{ display: 'flex', gap: '1rem', alignItems: 'flex-end', justifyContent: 'center', marginBottom: '1rem' }}>
                            <div>
                                <label className="text-muted mono-text" style={{ fontSize: '0.8rem' }}>POOL SIZE</label>
                                <input type="number" value={pool} onChange={(e) => setPool(parseInt(e.target.value) || 1)}
                                    style={{ display: 'block', width: '80px', height: '50px', fontSize: '2rem', textAlign: 'center', background: 'var(--bg-input)', color: 'var(--text-primary)', border: '1px solid var(--accent-primary)' }} />
                            </div>
                            <div>
                                <label className="text-muted mono-text" style={{ fontSize: '0.8rem' }}>AGAIN</label>
                                <select value={again} onChange={(e) => setAgain(parseInt(e.target.value))}
                                    style={{ display: 'block', height: '50px', background: 'var(--bg-input)', color: 'var(--text-primary)', border: '1px solid var(--border-color)' }}>
                                    <option value={10}>10-Again</option>
                                    <option value={9}>9-Again</option>
                                    <option value={8}>8-Again</option>
                                </select>
                            </div>
                            <button onClick={roll} style={{ height: '50px', padding: '0 2rem', background: 'var(--accent-primary)', color: 'var(--bg-dark)', border: 'none', fontWeight: 'bold', cursor: 'pointer', fontSize: '1.2rem' }}>
                                EXECUTE
                            </button>
                        </div>

                        {results && (
                            <div className="tech-border" style={{ padding: '1rem', background: 'rgba(0,0,0,0.3)' }}>
                                <div style={{ textAlign: 'center', marginBottom: '0.5rem' }}>
                                    <span className="mono-text text-muted">OUTCOME: </span>
                                    <span style={{ fontSize: '1.5rem', fontWeight: 'bold', color: results.totalSuccesses > 0 ? 'var(--accent-success)' : 'var(--text-secondary)' }}>
                                        {results.totalSuccesses} SUCCESSES
                                    </span>
                                </div>
                                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px', justifyContent: 'center' }}>
                                    {results.rolls.map((r, i) => (
                                        <div key={i} style={{
                                            width: '24px', height: '24px',
                                            borderRadius: '2px',
                                            background: r.success ? 'var(--accent-primary)' : 'var(--bg-panel)',
                                            color: r.success ? 'var(--bg-dark)' : 'var(--text-secondary)',
                                            display: 'flex', alignItems: 'center', justifyContent: 'center',
                                            fontWeight: 'bold',
                                            border: r.exploded ? '1px solid var(--accent-warning)' : 'none'
                                        }}>
                                            {r.value}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const InventoryModule = ({ inventory, update }) => (
                <div className="glass-panel" style={{ padding: '1.5rem', marginBottom: '1rem' }}>
                    <h3 className="mono-text text-accent" style={{ borderBottom: '1px solid var(--border-color)', paddingBottom: '0.5rem', marginBottom: '1rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        INVENTORY / ASSETS
                        <button onClick={() => update([...inventory, { name: "", bonus: 0, description: "" }])} title="Add Item" style={{ background: 'transparent', border: '1px solid var(--accent-primary)', color: 'var(--accent-primary)', width: '24px', height: '24px', borderRadius: '4px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <Icon name="plus" size={14} />
                        </button>
                    </h3>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))', gap: '1rem' }}>
                        {inventory.map((item, idx) => (
                            <div key={idx} className="tech-border" style={{ padding: '0.5rem', background: 'rgba(0,0,0,0.2)' }}>
                                <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center', marginBottom: '0.5rem' }}>
                                    <input
                                        type="text"
                                        placeholder="Item Name"
                                        value={item.name}
                                        onChange={(e) => update(inventory.map((it, i) => i === idx ? { ...it, name: e.target.value } : it))}
                                        style={{ background: 'transparent', border: 'none', borderBottom: '1px solid var(--text-muted)', color: 'var(--text-primary)', flex: 1, fontFamily: 'var(--font-mono)' }}
                                    />
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                        <span className="text-muted" style={{ fontSize: '0.8rem' }}>+</span>
                                        <input
                                            type="number"
                                            placeholder="Dice"
                                            title="Equipment Bonus Dice"
                                            value={item.bonus}
                                            onChange={(e) => update(inventory.map((it, i) => i === idx ? { ...it, bonus: parseInt(e.target.value) || 0 } : it))}
                                            style={{ background: 'transparent', border: '1px solid var(--border-color)', color: 'var(--accent-success)', width: '40px', textAlign: 'center' }}
                                        />
                                    </div>
                                    <button onClick={() => update(inventory.filter((_, i) => i !== idx))} style={{ background: 'transparent', border: 'none', color: 'var(--accent-danger)', cursor: 'pointer' }}>
                                        <Icon name="x" size={14} />
                                    </button>
                                </div>
                                <input
                                    type="text"
                                    placeholder="Notes..."
                                    value={item.description}
                                    onChange={(e) => update(inventory.map((it, i) => i === idx ? { ...it, description: e.target.value } : it))}
                                    style={{ width: '100%', background: 'transparent', border: 'none', color: 'var(--text-secondary)', fontSize: '0.8rem' }}
                                />
                            </div>
                        ))}
                    </div>
                </div>
            );



            const DerivedTraitsModule = ({ char, update }) => {
                // Auto Calculations
                const speed = 5 + char.attributes.power.physical + char.attributes.finesse.physical + (char.size || 5);
                const initMod = char.attributes.finesse.physical + char.attributes.resistance.social;
                const defense = Math.min(char.attributes.finesse.physical, char.attributes.finesse.mental) + (char.attributes.finesse.physical < char.attributes.finesse.mental ? 0 : 0); // Simplified lowest of Wits/Dex
                const willpowerMax = char.attributes.resistance.mental + char.attributes.resistance.social;
                // Health is Stamina + Size
                const healthMax = char.attributes.resistance.physical + (char.size || 5);

                return (
                    <div className="glass-panel" style={{ padding: '1.5rem', marginBottom: '1rem' }}>
                        <h3 className="mono-text text-accent" style={{ borderBottom: '1px solid var(--border-color)', paddingBottom: '0.5rem', marginBottom: '1rem' }}>DERIVED TRAITS</h3>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(140px, 1fr))', gap: '1rem' }}>
                            <div className="tech-border text-center" style={{ padding: '0.5rem' }}>
                                <div className="text-secondary mono-text" style={{ fontSize: '0.8rem' }}>HEALTH</div>
                                <div className="text-accent" style={{ fontSize: '1.5rem' }}>{healthMax}</div>
                                <div style={{ fontSize: '0.7rem', color: 'var(--text-muted)' }}>Stamina + Size</div>
                            </div>
                            <div className="tech-border text-center" style={{ padding: '0.5rem' }}>
                                <div className="text-secondary mono-text" style={{ fontSize: '0.8rem' }}>WILLPOWER</div>
                                <div className="text-accent" style={{ fontSize: '1.5rem' }}>{willpowerMax}</div>
                                <div style={{ fontSize: '0.7rem', color: 'var(--text-muted)' }}>Resolve + Composure</div>
                            </div>
                            <div className="tech-border text-center" style={{ padding: '0.5rem' }}>
                                <div className="text-secondary mono-text" style={{ fontSize: '0.8rem' }}>INITIATIVE</div>
                                <div className="text-primary" style={{ fontSize: '1.5rem' }}>{initMod}</div>
                                <div style={{ fontSize: '0.7rem', color: 'var(--text-muted)' }}>Dex + Comp</div>
                            </div>
                            <div className="tech-border text-center" style={{ padding: '0.5rem' }}>
                                <div className="text-secondary mono-text" style={{ fontSize: '0.8rem' }}>DEFENSE</div>
                                <div className="text-primary" style={{ fontSize: '1.5rem' }}>{defense}</div>
                                <div style={{ fontSize: '0.7rem', color: 'var(--text-muted)' }}>Lowest(Wits, Dex)</div>
                            </div>
                            <div className="tech-border text-center" style={{ padding: '0.5rem' }}>
                                <div className="text-secondary mono-text" style={{ fontSize: '0.8rem' }}>SPEED</div>
                                <div className="text-primary" style={{ fontSize: '1.5rem' }}>{speed}</div>
                                <div style={{ fontSize: '0.7rem', color: 'var(--text-muted)' }}>Str + Dex + 5</div>
                            </div>
                            <div className="tech-border text-center" style={{ padding: '0.5rem' }}>
                                <div className="text-secondary mono-text" style={{ fontSize: '0.8rem' }}>SIZE</div>
                                <input type="number" value={char.size || 5} onChange={(e) => update({ size: parseInt(e.target.value) || 5 })}
                                    style={{ background: 'transparent', border: 'none', color: 'var(--text-primary)', width: '100%', textAlign: 'center', fontSize: '1.5rem' }} />
                            </div>
                        </div>
                    </div>
                );
            };

            // ... (App component)

            if (booting) {
                return (
                    <div className="loading-screen">
                        <div style={{ width: '300px' }}>
                            {bootLog.map((log, i) => (
                                <div key={i} className="boot-text">{log}</div>
                            ))}
                            <div className="boot-text" style={{ animation: 'pulse 0.5s infinite', marginTop: '1rem' }}>_</div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="container">
                    <header style={{ marginBottom: '2rem', borderBottom: '1px solid var(--border-color)', paddingBottom: '1rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div>
                            <h1 className="mono-text text-accent" style={{ fontSize: '1.5rem', letterSpacing: '2px' }}>
                                BLACKLOG.NET <span className="text-muted">//</span> PERSONNEL
                            </h1>
                        </div>
                        {activeChar && (
                            <div style={{ display: 'flex', gap: '1rem' }}>
                                <button className="mono-text" style={{ background: 'transparent', border: '1px solid var(--text-muted)', color: 'var(--text-muted)', padding: '0.5rem 1rem', cursor: 'pointer' }}
                                    onClick={() => {
                                        const blob = new Blob([JSON.stringify(activeChar)], { type: 'application/json' });
                                        const url = URL.createObjectURL(blob);
                                        const a = document.createElement('a');
                                        a.href = url;
                                        a.download = `${activeChar.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_record.json`;
                                        a.click();
                                    }}
                                >
                                    <Icon name="download" size={14} /> EXPORT
                                </button>
                                <button onClick={() => setActiveCharId(null)} className="mono-text" style={{ background: 'transparent', border: '1px solid var(--accent-primary)', color: 'var(--accent-primary)', padding: '0.5rem 1rem', cursor: 'pointer' }}>
                                    &lt; CLOSE RECORD
                                </button>
                            </div>
                        )}
                    </header>

                    {!activeChar ? (
                        <Dashboard
                            characters={characters}
                            onCreate={createCharacter}
                            onSelect={setActiveCharId}
                            onDelete={deleteCharacter}
                        />
                    ) : (
                        <div className="fade-in">
                            <HeaderModule char={activeChar} update={updateActiveCharacter} />

                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '1rem', marginBottom: '1rem' }}>
                                <AttributesModule attributes={activeChar.attributes} update={attrs => updateActiveCharacter({ attributes: attrs })} />
                                <SkillsModule skills={activeChar.skills} update={skills => updateActiveCharacter({ skills })} />
                            </div>

                            <DerivedTraitsModule char={activeChar} update={updateActiveCharacter} />

                            <InventoryModule inventory={activeChar.inventory || []} update={(inv) => updateActiveCharacter({ inventory: inv })} />

                            <HealthModule
                                health={activeChar.health}
                                max={activeChar.attributes.resistance.physical + (activeChar.size || 5)}
                                update={(h) => updateActiveCharacter({ health: h })}
                            />

                            <DiceRoller char={activeChar} />

                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '1rem' }}>
                                <ExpandableListModule
                                    title="PULLING STRINGS" itemLabel="Asset Name"
                                    items={activeChar.pullingStrings || []}
                                    onAdd={() => updateActiveCharacter({ pullingStrings: [...(activeChar.pullingStrings || []), { name: "", rating: 1, description: "" }] })}
                                    onRemove={(idx) => updateActiveCharacter({ pullingStrings: activeChar.pullingStrings.filter((_, i) => i !== idx) })}
                                    onUpdate={(idx, val) => updateActiveCharacter({ pullingStrings: activeChar.pullingStrings.map((item, i) => i === idx ? val : item) })}
                                />
                                <ExpandableListModule
                                    title="MERITS" itemLabel="Merit Name"
                                    items={activeChar.merits}
                                    onAdd={() => updateActiveCharacter({ merits: [...activeChar.merits, { name: "", rating: 1, description: "" }] })}
                                    onRemove={(idx) => updateActiveCharacter({ merits: activeChar.merits.filter((_, i) => i !== idx) })}
                                    onUpdate={(idx, val) => updateActiveCharacter({ merits: activeChar.merits.map((item, i) => i === idx ? val : item) })}
                                />
                            </div>
                        </div>
                    )}
                </div>
            );
        };


        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>